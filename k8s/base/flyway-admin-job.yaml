# Argo CD PostSync hook: run DB migrations after Sync (Postgres, etc.) succeeds.
# Order: PreSync → Sync (infra + app) → PostSync (this Job). Hook 失败则 Sync 失败.
apiVersion: batch/v1
kind: Job
metadata:
  name: flyway-admin
  namespace: shortlink
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "0"
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600   # keep Pod for debugging
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: flyway
          image: nanachi1027/shortlink-flyway:latest
          command: ["java", "-jar", "/app/app.jar"]
          env:
            - name: FLYWAY_DB_URL
              value: jdbc:postgresql://postgres.shortlink.svc.cluster.local:5432/admin
            - name: FLYWAY_DB_USER
              value: admin
            - name: FLYWAY_DB_PASSWORD
              value: admin
            - name: FLYWAY_SCHEMA_TABLE
              value: flyway_schema_history_admin
            - name: FLYWAY_LOCATIONS
              value: classpath:migration/db/admin
            - name: FLYWAY_BASELINE_ON_MIGRATE
              value: "false"
            - name: FLYWAY_OUT_OF_ORDER
              value: "true"

