apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: vs-shortlink
  namespace: istio-system
spec:
  hosts:
    - "*" # at the beginning, allow all hosts for debugging easy
  gateways:
    - shortlink-gateway # cross namespace ${ns}/${gw-name} virtual service bind to gateway is required
  http:
    # ========== Monitoring UIs ==========
    # Kafka UI - web-based Kafka monitoring (topics, brokers, consumers, messages)
    - match:
        - uri:
            prefix: /kafka-ui
      rewrite:
        uri: /
      route:
        - destination:
            host: kafka-ui.shortlink.svc.cluster.local
            port:
              number: 8080
    # ClickHouse UI (Tabix) - SQL editor and table browser for ClickHouse
    - match:
        - uri:
            prefix: /clickhouse-ui
      rewrite:
        uri: /
      route:
        - destination:
            host: clickhouse-ui.shortlink.svc.cluster.local
            port:
              number: 80
    # ClickHouse Play UI - built-in ClickHouse SQL editor (native)
    - match:
        - uri:
            prefix: /clickhouse-play
      rewrite:
        uri: /play
      route:
        - destination:
            host: clickhouse.shortlink.svc.cluster.local
            port:
              number: 8123
    # ========== Application APIs ==========
    - match:
        - uri:
            prefix: /api/shortlink/admin
      route:
        - destination:
            host: admin.shortlink.svc.cluster.local
            port:
              number: 8082 # this port should be the port declared in the associated service
    - match:
        - uri:
            prefix: /api/shortlink
      route:
        - destination:
            host: shortlink.shortlink.svc.cluster.local
            port:
              number: 8081 # this port should be the port declared in the associated service

